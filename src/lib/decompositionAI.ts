/**
 * ä»»åŠ¡æ‹†è§£AIæœåŠ¡
 * ç”¨äºæ ¹æ®ä»»åŠ¡å†…å®¹åŠ¨æ€ç”Ÿæˆæ‹†è§£å¼•å¯¼é—®é¢˜
 */

import type { Task } from '@/types'
import { generateContextQuestions } from './contextQuestions'

// è±†åŒ…å¤§æ¨¡å‹é…ç½®
const DOUBAO_CONFIG = {
  endpoint: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
  model: 'doubao-seed-1-6-vision-250815',
}

/**
 * æ ¹æ®ä»»åŠ¡å†…å®¹åŠ¨æ€ç”Ÿæˆ3ä¸ªä»»åŠ¡æ‹†è§£å¼•å¯¼é—®é¢˜
 * @param task éœ€è¦æ‹†è§£çš„ä»»åŠ¡
 * @returns 3ä¸ªé—®é¢˜çš„æ•°ç»„
 */
export async function generateDynamicDecompositionQuestions(task: Task): Promise<string[]> {
  try {
    // æ„å»ºä»»åŠ¡ä¿¡æ¯æè¿°
    const taskInfo = buildTaskInfoDescription(task)
    
    // æ„å»ºAI prompt
    const systemPrompt = `ä½ æ˜¯ä¸€ä½æ“…é•¿ä»»åŠ¡æƒ…å¢ƒåˆ†æçš„æ™ºèƒ½åŠ©æ‰‹ã€‚ä½ çš„ç›®æ ‡æ˜¯ï¼šé€šè¿‡3ä¸ªç²¾å‡†çš„å¼€æ”¾å¼é—®é¢˜ï¼Œæ”¶é›†ç”¨æˆ·ä»»åŠ¡çš„å…³é”®æ‰§è¡Œæƒ…å¢ƒï¼Œä½¿åç»­AIæ‹†è§£èƒ½ç”ŸæˆçœŸæ­£å¯è½åœ°ã€ç¬¦åˆç”¨æˆ·å®é™…æ¡ä»¶çš„å­ä»»åŠ¡æ–¹æ¡ˆã€‚

### ã€å†…éƒ¨åˆ†ææµç¨‹ã€‘ï¼ˆåªåœ¨è„‘å†…æ‰§è¡Œï¼Œä¸è¦è¾“å‡ºï¼‰

1. **ç†è§£ä»»åŠ¡è¯­ä¹‰ä¸æ¨æ–­ç±»å‹**
   - è¯†åˆ«ä»»åŠ¡æ ¸å¿ƒåŠ¨ä½œï¼ˆå†™/è¯„/å‡†å¤‡/æ•´ç†/å­¦ä¹ /åš/å‚ä¸/å¤„ç†ç­‰ï¼‰
   - åŸºäºå¸¸è¯†å½’ç±»ä»»åŠ¡å¤§ç±»ï¼Œæ¨æ–­å…¸å‹æ‰§è¡Œè¦ç´ 
   - **ä¸“æœ‰åè¯å¤„ç†è§„åˆ™**ï¼š
     * "CHIå®¡ç¨¿/Review" â†’ å­¦æœ¯è®ºæ–‡è¯„å®¡ â†’ å…³æ³¨è¯„å®¡ç»´åº¦ã€è®ºæ–‡ç±»å‹ã€å®¡ç¨¿è¡¨å•
     * "åšTA/åŠ©æ•™" â†’ æ•™å­¦è¾…åŠ©å·¥ä½œ â†’ å…³æ³¨è¯¾ç¨‹å†…å®¹ã€å­¦ç”Ÿè§„æ¨¡ã€å…·ä½“èŒè´£
     * "å‡†å¤‡Presentation" â†’ æ¼”è®²å‡†å¤‡ â†’ å…³æ³¨å—ä¼—ã€æ—¶é•¿ã€æ ¸å¿ƒè§‚ç‚¹
     * è‹¥é‡åˆ°å®Œå…¨é™Œç”Ÿçš„ä¸“æœ‰åè¯ï¼Œè¯¢é—®å…¶"å…·ä½“è¦åšä»€ä¹ˆ/äº§å‡ºä»€ä¹ˆ"ï¼Œè€Œéç›´æ¥é—®"è¿™æ˜¯ä»€ä¹ˆ"

2. **è¯Šæ–­ä¿¡æ¯ç¼ºå£ï¼ˆå¯¹æ‹†è§£å½±å“æœ€å¤§çš„3é¡¹ï¼‰**
   ä»ä»¥ä¸‹ç»´åº¦ä¸­ï¼Œé€‰å‡º"ç”¨æˆ·æœªæåŠ"ä¸”"å¯¹åç»­æ‹†è§£æœ€å…³é”®"çš„3ä¸ªï¼š
   - ç›®æ ‡/æˆæœå½¢å¼ï¼šæœ€ç»ˆè¦äº§å‡ºä»€ä¹ˆï¼Ÿï¼ˆå¦‚æ–‡æ¡£ã€è¯„å®¡æ„è§ã€PPTã€æ¸…å•ç­‰ï¼‰
   - èŒƒå›´/è¾¹ç•Œï¼šå“ªäº›åšã€å“ªäº›ä¸åšï¼Ÿé‡ç‚¹åœ¨å“ªéƒ¨åˆ†ï¼Ÿ
   - ç°æœ‰èµ„æºï¼šå·²æœ‰ä»€ä¹ˆææ–™/ä¿¡æ¯/å·¥å…·ï¼Ÿéœ€è¦ä»€ä¹ˆä¾èµ–è¾“å…¥ï¼Ÿ
   - æ—¶é—´èŠ‚å¥ï¼šæœ‰å“ªäº›å…³é”®æ—¶é—´èŠ‚ç‚¹ï¼Ÿæ¯ä¸ªé˜¶æ®µé¢„è®¡å¤šä¹…ï¼Ÿ
   - åä½œ/ä¾èµ–ï¼šæ¶‰åŠå“ªäº›äººï¼Ÿéœ€è¦è°æä¾›ä»€ä¹ˆï¼Ÿ
   - æ‰§è¡Œèµ·ç‚¹ï¼šä»å“ªä¸ªéƒ¨åˆ†æœ€å®¹æ˜“ä¸Šæ‰‹ï¼Ÿç¬¬ä¸€æ­¥æœ€å¯èƒ½åšä»€ä¹ˆï¼Ÿ
   - æ½œåœ¨éšœç¢ï¼šæœ€æ‹…å¿ƒå¡åœ¨å“ªé‡Œï¼Ÿå“ªéƒ¨åˆ†æœ€ä¸ç¡®å®šï¼Ÿ

3. **è®¾è®¡3ä¸ªäº’è¡¥é—®é¢˜ï¼ˆéµå¾ª"æˆæœâ†’èµ„æº/è¾¹ç•Œâ†’å¯åŠ¨/éšœç¢"é€’è¿›ï¼‰**
   - ç¬¬1é—®ï¼šä¼˜å…ˆæ¾„æ¸…"å…·ä½“äº§å‡ºä»€ä¹ˆ"æˆ–"æˆåŠŸæ ‡å‡†æ˜¯ä»€ä¹ˆ"ï¼ˆè®©æ‹†è§£æœ‰æ˜ç¡®ç»ˆç‚¹ï¼‰
   - ç¬¬2é—®ï¼šä¼˜å…ˆç›˜ç‚¹"å·²æœ‰ä»€ä¹ˆ/ç¼ºä»€ä¹ˆ"æˆ–"é‡ç‚¹åœ¨å“ªéƒ¨åˆ†"ï¼ˆè®©æ‹†è§£ç¬¦åˆèµ„æºç°çŠ¶ï¼‰
   - ç¬¬3é—®ï¼šä¼˜å…ˆå¼•å¯¼"ä»å“ªå¼€å§‹"æˆ–"æœ€æ‹…å¿ƒä»€ä¹ˆ"ï¼ˆè®©æ‹†è§£å¯ç«‹å³å¯åŠ¨/è§„é¿é£é™©ï¼‰
   - **äº’è¡¥æ€§æ£€æŸ¥**ï¼šä¸‰é—®å¿…é¡»è¦†ç›–ä¸åŒç»´åº¦ï¼Œé¿å…é‡å¤æˆ–ç›¸ä¼¼è¡¨è¿°

### ã€é—®é¢˜è®¾è®¡è¦æ±‚ã€‘

âœ… **å¿…é¡»åšåˆ°**ï¼š
- é¢å‘"å¯è§‚å¯Ÿã€å¯é‡åŒ–"çš„å…·ä½“ä¿¡æ¯ï¼ˆå¦‚ï¼šæ—¶é—´ç‚¹ã€å…·ä½“æ¨¡å—/ç« èŠ‚ã€å·²æœ‰æ–‡ä»¶/æ•°æ®ã€åä½œå¯¹è±¡ã€è¯„å®¡è¡¨å•ç»“æ„ï¼‰
- æ¯é—®åªé—®ä¸€ä»¶äº‹ï¼Œå¥å¼ç®€çŸ­ï¼ˆ15-28å­—ï¼‰ï¼Œæ˜“ç†è§£ã€ä½è®¤çŸ¥è´Ÿæ‹…
- å¼€æ”¾å¼é—®å¥ï¼ˆç”¨"ä»€ä¹ˆ/å¦‚ä½•/å“ªäº›/å“ªéƒ¨åˆ†/ä¸ºä»€ä¹ˆ"å¼€å¤´ï¼‰ï¼Œå¼•å¯¼è¯¦ç»†å›ç­”
- è®©ç”¨æˆ·è‡ªç„¶è”æƒ³æ‰§è¡Œåœºæ™¯ï¼Œè€ŒéæŠ½è±¡æ¦‚å¿µæˆ–æƒ…ç»ªåˆ¤æ–­

âŒ **ä¸¥æ ¼ç¦æ­¢**ï¼š
- æ˜¯/å¦é¢˜ã€æƒ…ç»ª/åŠ¨æœºé¢˜ï¼ˆå¦‚"éš¾å—""æœ‰ä¿¡å¿ƒå—""æƒ³åšå—"ï¼‰
- æ˜¾è€Œæ˜“è§çš„é—®é¢˜ï¼ˆå¦‚ç”¨æˆ·å·²è¯´æ˜çš„ä¿¡æ¯ã€ä»»åŠ¡åç§°æœ¬èº«å«ä¹‰çš„è§£é‡Šï¼‰
- **å·¥å…·/æ ¼å¼/æŠ€æœ¯ç»†èŠ‚**ï¼ˆå¦‚"ç”¨Wordè¿˜æ˜¯LaTeX""è¾“å‡ºä»€ä¹ˆæ ¼å¼çš„æ–‡ä»¶""å­—æ•°å¤šå°‘""ç”¨ä»€ä¹ˆè½¯ä»¶"ï¼‰
  * ä¾‹å¤–ï¼šä»…å½“å·¥å…·/æ ¼å¼é€‰æ‹©ç›´æ¥å½±å“ä»»åŠ¡æ‹†è§£é€»è¾‘æ—¶æ‰å¯è¯¢é—®ï¼ˆå¦‚"åšè§†é¢‘"éœ€ç¡®è®¤æ˜¯å‰ªè¾‘è¿˜æ˜¯æ‹æ‘„ï¼‰
  * åŸåˆ™ï¼šå¤šé—®"ç”¨æ¥å¹²ä»€ä¹ˆ"ï¼Œå°‘é—®"ç”¨ä»€ä¹ˆåš"ï¼›å¤šé—®"åœ¨ä»€ä¹ˆçŠ¶æ€"ï¼Œå°‘é—®"å…·ä½“æ˜¯ä»€ä¹ˆæ ¼å¼"
- å¤æ‚åµŒå¥—é—®é¢˜ï¼ˆå¦‚"ä½ çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Œä»¥åŠä½ æ‰“ç®—æ€ä¹ˆåšï¼Ÿ"åº”æ‹†æˆä¸¤é—®ï¼‰
- ç©ºæ³›ç¬¼ç»Ÿçš„é—®é¢˜ï¼ˆå¦‚"ä½ æ‰“ç®—æ€ä¹ˆåš""æœ‰ä»€ä¹ˆè®¡åˆ’"ï¼‰
- **è¿‡äºç»†ç¢çš„ä¿¡æ¯æ”¶é›†**ï¼ˆå¦‚"å·²ç»æ”¶é›†äº†å“ªäº›æ–‡çŒ®çš„ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€ä½œè€…ã€å¹´ä»½ï¼‰"ï¼‰
  * æ”¹é—®"ç°åœ¨æ–‡çŒ®åœ¨ä»€ä¹ˆçŠ¶æ€ï¼ˆæœ‰å¤šå°‘ç¯‡/æ˜¯å¦å·²è¯»/å¦‚ä½•å­˜æ”¾ï¼‰"

### ã€ä»»åŠ¡ç±»å‹æ¨ç†å‚è€ƒã€‘ï¼ˆç”¨äºæé«˜é—®é¢˜é’ˆå¯¹æ€§ï¼‰

- **å­¦æœ¯å†™ä½œ**ï¼ˆè®ºæ–‡/æ‘˜è¦/æŠ¥å‘Šï¼‰â†’ é—®ï¼šé‡ç‚¹è®ºè¯ä»€ä¹ˆï¼Ÿå·²æœ‰å“ªäº›å®éªŒæ•°æ®æˆ–æ–‡çŒ®ç»¼è¿°ï¼Ÿä»å“ªä¸ªç« èŠ‚/éƒ¨åˆ†æœ€å®¹æ˜“ä¸Šæ‰‹ï¼Ÿ
- **è¯„å®¡/è¯„ä¼°**ï¼ˆå®¡ç¨¿/æ‰“åˆ†ï¼‰â†’ é—®ï¼šè¯„å®¡çš„é‡ç‚¹ç»´åº¦æ˜¯ä»€ä¹ˆï¼ˆåˆ›æ–°æ€§/æ–¹æ³•/å†™ä½œï¼‰ï¼Ÿéœ€è¦è¯„å®¡å‡ ç¯‡/ä»€ä¹ˆç±»å‹çš„ææ–™ï¼Ÿæ¯ç¯‡é¢„è®¡å¤šä¹…ï¼Ÿ
- **å‡†å¤‡/æ¼”ç¤º**ï¼ˆæ±‡æŠ¥/PPT/ç­”è¾©ï¼‰â†’ é—®ï¼šå—ä¼—æ˜¯è°/ä»–ä»¬æœ€å…³å¿ƒä»€ä¹ˆï¼Ÿä½ æƒ³ä¼ è¾¾çš„æ ¸å¿ƒè§‚ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿç°åœ¨å·²æœ‰å“ªäº›ç´ ææˆ–æ•°æ®ï¼Ÿ
- **æ•´ç†/å½’æ¡£**ï¼ˆç¬”è®°/æ–‡ä»¶/æ–‡çŒ®ï¼‰â†’ é—®ï¼šæ•´ç†åç”¨äºä»€ä¹ˆåœºæ™¯ï¼ˆå†™è®ºæ–‡/å¤ä¹ /åˆ†äº«ï¼‰ï¼Ÿç°åœ¨è¿™äº›ææ–™åœ¨ä»€ä¹ˆçŠ¶æ€ï¼ˆæ•£è½/éƒ¨åˆ†å·²åˆ†ç±»/å®Œå…¨æ··ä¹±ï¼‰ï¼Ÿä½ å¸Œæœ›æŒ‰ä»€ä¹ˆç»´åº¦ç»„ç»‡ï¼ˆä¸»é¢˜/æ—¶é—´/é‡è¦æ€§ï¼‰ï¼Ÿ
- **å­¦ä¹ /æŒæ¡**ï¼ˆå¤ä¹ /ç»ƒä¹ ï¼‰â†’ é—®ï¼šå“ªäº›å†…å®¹æ˜¯å·²ç»ç†è§£çš„ï¼Ÿå“ªéƒ¨åˆ†æœ€è–„å¼±æˆ–æœ€æ‹…å¿ƒï¼Ÿä½ æ‰“ç®—å¦‚ä½•æ£€éªŒè‡ªå·±æ˜¯å¦æŒæ¡ï¼Ÿ
- **æ•™å­¦/è¾…åŠ©**ï¼ˆåšTA/å¤‡è¯¾ï¼‰â†’ é—®ï¼šä½ å…·ä½“è´Ÿè´£å“ªéƒ¨åˆ†å·¥ä½œï¼ˆè®²è§£/ç­”ç–‘/æ‰¹æ”¹ä½œä¸šï¼‰ï¼Ÿå­¦ç”Ÿå¤§æ¦‚å¤šå°‘äºº/ä»€ä¹ˆæ°´å¹³ï¼Ÿè¯¾ç¨‹è¿›åº¦åˆ°å“ªäº†ï¼Ÿ
- **ä¼šè®®/æ´»åŠ¨**ï¼ˆç»„ç»‡/å‚åŠ ï¼‰â†’ é—®ï¼šä½ åœ¨å…¶ä¸­çš„è§’è‰²æ˜¯ä»€ä¹ˆ/éœ€è¦åšä»€ä¹ˆï¼Ÿæœ‰å“ªäº›å…³é”®æ—¶é—´èŠ‚ç‚¹æˆ–é‡Œç¨‹ç¢‘ï¼Ÿéœ€è¦æå‰å‡†å¤‡ä»€ä¹ˆææ–™æˆ–ä¿¡æ¯ï¼Ÿ

### ã€åä¾‹å¯¹æ¯”ã€‘ï¼ˆç†è§£"ç›®çš„å¯¼å‘"vs"æŠ€æœ¯ç»†èŠ‚å¯¼å‘"ï¼‰

**ä»»åŠ¡ï¼šæ•´ç†å‚è€ƒæ–‡çŒ®**

âŒ **å·®çš„é—®é¢˜**ï¼ˆæŠ€æœ¯ç»†èŠ‚/è¿‡äºç»†ç¢ï¼‰ï¼š
- ä½ æ•´ç†å‚è€ƒæ–‡çŒ®åè¦è¾“å‡ºä»€ä¹ˆæ ¼å¼çš„æ–‡ä»¶ï¼ˆå¦‚EndNoteåº“ã€Excelè¡¨ã€Wordåˆ—è¡¨ï¼‰ï¼Ÿ
- ä½ ç°åœ¨å·²ç»æ”¶é›†äº†å“ªäº›æ–‡çŒ®çš„ä¿¡æ¯ï¼ˆå¦‚æ ‡é¢˜ã€ä½œè€…ã€å¹´ä»½ï¼‰ï¼Ÿ
- ä½ æ‰“ç®—ç”¨ä»€ä¹ˆè½¯ä»¶æ¥ç®¡ç†è¿™äº›æ–‡çŒ®ï¼Ÿ

âœ… **å¥½çš„é—®é¢˜**ï¼ˆç›®çš„/çŠ¶æ€/æ‰§è¡Œå¯¼å‘ï¼‰ï¼š
- ä½ æ•´ç†è¿™äº›æ–‡çŒ®æ˜¯ä¸ºäº†ç”¨åœ¨ä»€ä¹ˆåœºæ™¯ï¼ˆå†™è®ºæ–‡çš„æŸä¸ªç« èŠ‚/åšæ–‡çŒ®ç»¼è¿°/å‡†å¤‡å¼€é¢˜æŠ¥å‘Šï¼‰ï¼Ÿ
- è¿™äº›æ–‡çŒ®ç°åœ¨æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼ˆæ•£è½åœ¨å„å¤„PDF/éƒ¨åˆ†å·²è¯»å¹¶æ ‡æ³¨/è¿˜æ˜¯åªæœ‰æ ‡é¢˜æ¸…å•ï¼‰ï¼Ÿ
- ä½ å¸Œæœ›æŒ‰ä»€ä¹ˆç»´åº¦æ¥ç»„ç»‡è¿™äº›æ–‡çŒ®ï¼ˆæŒ‰ä¸»é¢˜åˆ†ç±»/æŒ‰ç ”ç©¶æ–¹æ³•/æŒ‰æ—¶é—´çº¿/æŒ‰ä¸ä½ ç ”ç©¶çš„ç›¸å…³æ€§ï¼‰ï¼Ÿ

### ã€ADHDå‹å¥½åŸåˆ™ã€‘

- æ¸©å’Œã€é¼“åŠ±ã€éè¯„åˆ¤æ€§è¯­æ°”ï¼ˆé¿å…"ä½ åº”è¯¥""å¿…é¡»""ä¸ºä»€ä¹ˆä¸"ï¼‰
- é™ä½å¯åŠ¨ç„¦è™‘ï¼Œå¼•å¯¼"ä¸‹ä¸€æ­¥å¯ä»¥åšä»€ä¹ˆ"è€Œé"ä¸ºä»€ä¹ˆæ²¡åš"
- é—®é¢˜é¡ºåºç¬¦åˆè‡ªç„¶æ€è€ƒæµç¨‹ï¼ˆå…ˆæƒ³æ¸…æ¥šç›®æ ‡ï¼Œå†ç›˜ç‚¹èµ„æºï¼Œæœ€åæ€è€ƒå¯åŠ¨ï¼‰

### ã€è¾“å‡ºæ ¼å¼ã€‘ï¼ˆä¸¥æ ¼éµå®ˆï¼‰

- ä»…è¾“å‡º3è¡Œé—®é¢˜
- æ¯è¡Œä»¥"- "å¼€å¤´
- ä¸æ·»åŠ ä»»ä½•è¯´æ˜ã€ç¼–å·ã€æ ‡é¢˜æˆ–å…¶ä»–æ–‡æœ¬

### ã€æˆåŠŸæ ‡å‡†ã€‘

ç”¨æˆ·å›ç­”åï¼Œåº”èƒ½è®©AIæ‹†è§£ç³»ç»Ÿè·å¾—ï¼š
âœ“ ä»»åŠ¡çš„å…·ä½“äº§å‡ºå½¢å¼ä¸æˆåŠŸæ ‡å‡†ï¼ˆæ‹†è§£æœ‰æ˜ç¡®ç»ˆç‚¹ï¼‰
âœ“ ç”¨æˆ·ç°æœ‰èµ„æº/ææ–™ä¸æ—¶é—´èŠ‚å¥ï¼ˆæ‹†è§£ç¬¦åˆå®é™…æ¡ä»¶ï¼‰
âœ“ åˆç†çš„æ‰§è¡Œèµ·ç‚¹ä¸æ½œåœ¨é£é™©ç‚¹ï¼ˆæ‹†è§£å¯ç«‹å³å¯åŠ¨ä¸”è§„é¿éšœç¢ï¼‰`

    const userPrompt = `è¯·åŸºäºä»¥ä¸‹ä»»åŠ¡ä¿¡æ¯ï¼Œç”Ÿæˆ3ä¸ªèƒ½æœ‰æ•ˆæ”¶é›†æ‰§è¡Œæƒ…å¢ƒçš„åæ€æ€§é—®é¢˜ï¼š

${taskInfo}

**ä½ çš„åˆ†ææµç¨‹**ï¼ˆå†…éƒ¨æ‰§è¡Œï¼Œä¸è¦è¾“å‡ºï¼‰ï¼š

1ï¸âƒ£ **ä»»åŠ¡ç±»å‹åˆ¤æ–­**
   - è¯†åˆ«æ ¸å¿ƒåŠ¨ä½œï¼ˆå¦‚ï¼šå†™ã€è¯„ã€å‡†å¤‡ã€æ•´ç†ã€å­¦ä¹ ã€åšç­‰ï¼‰
   - å½’ç±»ä»»åŠ¡å¤§ç±»å¹¶æ¨æ–­å…¸å‹æ‰§è¡Œè¦ç´ 
   - è‹¥é‡ä¸“æœ‰åè¯ï¼ˆå¦‚CHIå®¡ç¨¿/åšTA/æŸé¡¹ç›®ç¼©å†™ï¼‰ï¼ŒåŸºäºå¸¸è¯†æ¨æ–­å…¶æ‰€å±ç±»åˆ«ä¸å…³é”®è¦ç´ 

2ï¸âƒ£ **ä¿¡æ¯ç¼ºå£è¯Šæ–­**
   å¯¹æ¯”ä»»åŠ¡æè¿°ï¼Œä»ä»¥ä¸‹ç»´åº¦ä¸­æ‰¾å‡º"ç”¨æˆ·æœªæåŠ"ä¸”"å¯¹æ‹†è§£æœ€å…³é”®"çš„3é¡¹ï¼š
   - æˆæœå½¢å¼/ç›®æ ‡ï¼ˆè¦äº§å‡ºä»€ä¹ˆï¼ŸæˆåŠŸæ ‡å‡†ï¼Ÿï¼‰
   - èŒƒå›´/è¾¹ç•Œï¼ˆé‡ç‚¹åœ¨å“ªï¼Ÿå“ªäº›ä¸åšï¼Ÿï¼‰
   - ç°æœ‰èµ„æºï¼ˆå·²æœ‰ä»€ä¹ˆææ–™/ä¿¡æ¯/ä¾èµ–ï¼Ÿï¼‰
   - æ—¶é—´èŠ‚å¥ï¼ˆå…³é”®èŠ‚ç‚¹ï¼Ÿå„é˜¶æ®µé¢„æœŸæ—¶é•¿ï¼Ÿï¼‰
   - åä½œ/ä¾èµ–ï¼ˆæ¶‰åŠè°ï¼Ÿéœ€è¦è°æä¾›ä»€ä¹ˆï¼Ÿï¼‰
   - æ‰§è¡Œèµ·ç‚¹ï¼ˆä»å“ªæœ€å®¹æ˜“ä¸Šæ‰‹ï¼Ÿç¬¬ä¸€æ­¥å¯èƒ½åšä»€ä¹ˆï¼Ÿï¼‰
   - æ½œåœ¨éšœç¢ï¼ˆæœ€æ‹…å¿ƒä»€ä¹ˆï¼Ÿå“ªéƒ¨åˆ†æœ€ä¸ç¡®å®šï¼Ÿï¼‰

3ï¸âƒ£ **é—®é¢˜è®¾è®¡**ï¼ˆéµå¾ª"æˆæœâ†’èµ„æº/è¾¹ç•Œâ†’å¯åŠ¨/éšœç¢"é€’è¿›ï¼‰
   - ç¬¬1é—®ï¼šä¼˜å…ˆæ¾„æ¸…å…·ä½“äº§å‡ºæˆ–æˆåŠŸæ ‡å‡†
   - ç¬¬2é—®ï¼šä¼˜å…ˆç›˜ç‚¹å·²æœ‰èµ„æº/ææ–™æˆ–ä»»åŠ¡é‡ç‚¹èŒƒå›´
   - ç¬¬3é—®ï¼šä¼˜å…ˆå¼•å¯¼æ‰§è¡Œèµ·ç‚¹æˆ–æ½œåœ¨éšœç¢
   - **äº’è¡¥æ€§æ£€æŸ¥**ï¼šä¸‰é—®å¿…é¡»è¦†ç›–ä¸åŒç»´åº¦ï¼Œé¿å…é‡å¤

**è´¨é‡è‡ªæ£€**ï¼ˆå‡ºé¢˜å‰ç¡®è®¤ï¼‰ï¼š
âœ“ æ¯é—®æ˜¯å¦é¢å‘å…·ä½“ã€å¯è§‚å¯Ÿçš„ä¿¡æ¯ï¼ˆè€ŒéæŠ½è±¡æ¦‚å¿µ/æƒ…ç»ªï¼‰ï¼Ÿ
âœ“ æ˜¯å¦éƒ½æ˜¯å¼€æ”¾å¼é—®é¢˜ï¼ˆè€Œéæ˜¯/å¦é¢˜ï¼‰ï¼Ÿ
âœ“ æ˜¯å¦é¿å…äº†æ˜¾è€Œæ˜“è§/ç¬¼ç»Ÿ/å¤æ‚åµŒå¥—çš„é—®é¢˜ï¼Ÿ
âœ“ **æ˜¯å¦é¿å…äº†å·¥å…·/æ ¼å¼/æŠ€æœ¯ç»†èŠ‚**ï¼ˆå¤šé—®"ç”¨æ¥å¹²ä»€ä¹ˆ""åœ¨ä»€ä¹ˆçŠ¶æ€"ï¼Œå°‘é—®"ç”¨ä»€ä¹ˆåš""ä»€ä¹ˆæ ¼å¼"ï¼‰ï¼Ÿ
âœ“ **æ˜¯å¦é¿å…äº†è¿‡äºç»†ç¢çš„ä¿¡æ¯æ”¶é›†**ï¼ˆå¦‚"æ”¶é›†äº†å“ªäº›å­—æ®µ"åº”æ”¹ä¸º"ç°åœ¨åœ¨ä»€ä¹ˆçŠ¶æ€/æœ‰å¤šå°‘"ï¼‰ï¼Ÿ
âœ“ ä¸‰é—®æ˜¯å¦äº’è¡¥ä¸”ç¬¦åˆé€’è¿›é€»è¾‘ï¼Ÿ

è¯·ç›´æ¥è¾“å‡º3ä¸ªé—®é¢˜ï¼ˆæ¯è¡Œä»¥"- "å¼€å¤´ï¼Œä¸è¦ä»»ä½•é¢å¤–æ–‡å­—ï¼‰ï¼š`

    // Add English instruction to ensure English output
    const userPromptWithEnglish = userPrompt + `

**CRITICAL: Generate ALL 3 questions in ENGLISH ONLY. Do NOT respond in Chinese. Each question must start with "- "`

    // è°ƒç”¨è±†åŒ…API
    const apiKey = process.env.NEXT_PUBLIC_DOUBAO_API_KEY
    if (!apiKey) {
      throw new Error('NEXT_PUBLIC_DOUBAO_API_KEY not configured')
    }

    const response = await fetch(DOUBAO_CONFIG.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: DOUBAO_CONFIG.model,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPromptWithEnglish }
        ],
        temperature: 0.7, // ç¨é«˜çš„æ¸©åº¦ï¼Œå¢åŠ åˆ›é€ æ€§
        max_tokens: 200, // 3ä¸ªé—®é¢˜ï¼Œæ¯ä¸ªçº¦30å­—ï¼Œç¨å¾®å¤šä¸€ç‚¹buffer
        thinking: { type: 'disabled' } // å…³é—­æ·±åº¦æ€è€ƒï¼Œæå‡å“åº”é€Ÿåº¦
      }),
    })

    if (!response.ok) {
      throw new Error(`Doubao API error: ${response.status}`)
    }

    const data = await response.json()
    const content = data.choices?.[0]?.message?.content || ''
    
    // è§£æAIè¿”å›çš„é—®é¢˜
    const questions = parseQuestionsFromResponse(content)
    
    // å¦‚æœè§£æå¤±è´¥æˆ–é—®é¢˜æ•°é‡ä¸å¯¹ï¼ŒæŠ›å‡ºé”™è¯¯è§¦å‘é™çº§
    if (questions.length !== 3) {
      throw new Error(`Expected 3 questions, got ${questions.length}`)
    }
    
    return questions
    
  } catch (error) {
    console.error('AIæ‹†è§£é—®é¢˜ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ:', error)
    // æŠ›å‡ºé”™è¯¯ï¼Œç”±è°ƒç”¨æ–¹å†³å®šæ˜¯å¦ä½¿ç”¨é™çº§æ–¹æ¡ˆ
    throw error
  }
}

/**
 * æ„å»ºä»»åŠ¡ä¿¡æ¯æè¿°ï¼ˆä¼ é€’ç»™AIï¼‰
 */
function buildTaskInfoDescription(task: Task): string {
  const parts: string[] = []
  
  // 1. ä»»åŠ¡æ ‡é¢˜
  parts.push(`ä»»åŠ¡æ ‡é¢˜ï¼š${task.title}`)
  
  // 2. ä»»åŠ¡æè¿°
  if (task.description && task.description.trim().length > 0) {
    parts.push(`ä»»åŠ¡æè¿°ï¼š${task.description}`)
  } else {
    parts.push(`ä»»åŠ¡æè¿°ï¼šï¼ˆæœªå¡«å†™ï¼‰`)
  }
  
  // 3. æˆªæ­¢æ—¶é—´
  if (task.deadline_datetime) {
    const deadline = new Date(task.deadline_datetime)
    const deadlineStr = deadline.toLocaleString('zh-CN', {
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      weekday: 'short'
    })
    parts.push(`æˆªæ­¢æ—¶é—´ï¼š${deadlineStr}`)
  } else {
    parts.push(`æˆªæ­¢æ—¶é—´ï¼šï¼ˆæœªè®¾ç½®ï¼‰`)
  }
  
  // 4. é¢„ä¼°æ—¶é•¿
  if (task.estimated_duration) {
    // estimated_duration ç°åœ¨æ˜¯æ•°å­—ï¼ˆåˆ†é’Ÿï¼‰
    const totalMinutes = task.estimated_duration % 10000 // å»é™¤bufferæ ‡è®°
    const hours = Math.floor(totalMinutes / 60)
    const minutes = totalMinutes % 60
    let durationStr = ''
    if (hours > 0) durationStr += `${hours}å°æ—¶`
    if (minutes > 0) durationStr += `${minutes}åˆ†é’Ÿ`
    parts.push(`é¢„ä¼°æ—¶é•¿ï¼š${durationStr || 'æœªçŸ¥'}`)
  } else {
    parts.push(`é¢„ä¼°æ—¶é•¿ï¼šï¼ˆæœªè®¾ç½®ï¼‰`)
  }
  
  // 5. æ ‡ç­¾/å¤æ‚åº¦æç¤º
  if (task.tags && task.tags.length > 0) {
    const complexityTags = task.tags.filter(tag => 
      ['difficult', 'easy', 'important', 'urgent'].includes(tag)
    )
    if (complexityTags.length > 0) {
      parts.push(`ä»»åŠ¡ç‰¹ç‚¹ï¼š${complexityTags.join('ã€')}`)
    }
  }
  
  // 6. å·²æœ‰å­ä»»åŠ¡æç¤º
  if (task.subtasks && task.subtasks.length > 0) {
    parts.push(`å¤‡æ³¨ï¼šç”¨æˆ·å·²åˆ›å»ºäº†${task.subtasks.length}ä¸ªå­ä»»åŠ¡ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–`)
  }
  
  return parts.join('\n')
}

/**
 * ä»AIå“åº”ä¸­è§£æé—®é¢˜åˆ—è¡¨
 */
function parseQuestionsFromResponse(content: string): string[] {
  const questions: string[] = []
  
  // æŒ‰è¡Œåˆ†å‰²
  const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0)
  
  for (const line of lines) {
    // åŒ¹é…ä»¥ "- " å¼€å¤´çš„è¡Œ
    if (line.startsWith('- ')) {
      const question = line.substring(2).trim()
      if (question.length > 0) {
        questions.push(question)
      }
    }
    // ä¹Ÿå…¼å®¹å…¶ä»–å¯èƒ½çš„æ ¼å¼ï¼šæ•°å­—ç¼–å·
    else if (/^\d+[\.)ã€]/.test(line)) {
      const question = line.replace(/^\d+[\.)ã€]\s*/, '').trim()
      if (question.length > 0) {
        questions.push(question)
      }
    }
  }
  
  return questions
}

/**
 * æ ¼å¼åŒ–AIç”Ÿæˆçš„é—®é¢˜ä¸ºæ¶ˆæ¯æ–‡æœ¬
 * @param task ä»»åŠ¡
 * @param questions é—®é¢˜æ•°ç»„
 * @returns æ ¼å¼åŒ–åçš„æ¶ˆæ¯æ–‡æœ¬
 */
export function formatDynamicDecompositionMessage(task: Task, questions: string[]): string {
  const questionList = questions
    .map((q, i) => `${i + 1}. ${q}`)
    .join('\n\n')

  return `å¥½çš„ï¼åœ¨å¼€å§‹æ‹†è§£ã€Œ${task.title}ã€ä¹‹å‰ï¼Œæˆ‘æƒ³äº†è§£ä¸€äº›èƒŒæ™¯ä¿¡æ¯ï¼š

${questionList}

ğŸ’¡ è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å›ç­”è¿™äº›é—®é¢˜ï¼Œä¹Ÿå¯ä»¥æä¾›å…¶ä»–ä»»ä½•ä½ çŸ¥é“çš„ä¿¡æ¯ï¼ˆå¯ä»¥è‡ªç”±æè¿°ï¼Œä¸éœ€è¦ä¸¥æ ¼æŒ‰é—®é¢˜åºå·ï¼‰`
}

/**
 * ç”Ÿæˆä»»åŠ¡æ‹†è§£é—®é¢˜ï¼ˆå¸¦é™çº§æ–¹æ¡ˆï¼‰
 * ä¼˜å…ˆä½¿ç”¨AIåŠ¨æ€ç”Ÿæˆï¼Œå¤±è´¥æ—¶å›é€€åˆ°è§„åˆ™æ¨¡æ¿
 * @param task éœ€è¦æ‹†è§£çš„ä»»åŠ¡
 * @returns é—®é¢˜æ•°ç»„å’Œæ¶ˆæ¯æ–‡æœ¬
 */
export async function generateDecompositionQuestionsWithFallback(task: Task): Promise<{
  questions: string[]
  message: string
  isAIGenerated: boolean
}> {
  try {
    // å°è¯•ä½¿ç”¨AIç”Ÿæˆ
    const aiQuestions = await generateDynamicDecompositionQuestions(task)
    const aiMessage = formatDynamicDecompositionMessage(task, aiQuestions)
    
    return {
      questions: aiQuestions,
      message: aiMessage,
      isAIGenerated: true
    }
  } catch (error) {
    console.warn('AIæ‹†è§£é—®é¢˜ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨è§„åˆ™æ¨¡æ¿é™çº§æ–¹æ¡ˆ')
    
    // é™çº§åˆ°è§„åˆ™æ¨¡æ¿
    const ruleBasedQuestions = generateContextQuestions(task)
    const ruleBasedMessage = `å¥½çš„ï¼åœ¨å¼€å§‹æ‹†è§£ã€Œ${task.title}ã€ä¹‹å‰ï¼Œæˆ‘æƒ³äº†è§£ä¸€äº›èƒŒæ™¯ä¿¡æ¯ï¼š

${ruleBasedQuestions.map((q, i) => `${i + 1}. ${q}`).join('\n\n')}

ğŸ’¡ è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å›ç­”è¿™äº›é—®é¢˜ï¼Œä¹Ÿå¯ä»¥æä¾›å…¶ä»–ä»»ä½•ä½ çŸ¥é“çš„ä¿¡æ¯ï¼ˆå¯ä»¥è‡ªç”±æè¿°ï¼Œä¸éœ€è¦ä¸¥æ ¼æŒ‰é—®é¢˜åºå·ï¼‰`
    
    return {
      questions: ruleBasedQuestions,
      message: ruleBasedMessage,
      isAIGenerated: false
    }
  }
}









