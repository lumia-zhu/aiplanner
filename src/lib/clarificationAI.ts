/**
 * ä»»åŠ¡æ¾„æ¸…AIæœåŠ¡
 * ç”¨äºæ ¹æ®ä»»åŠ¡å†…å®¹åŠ¨æ€ç”Ÿæˆè‹æ ¼æ‹‰åº•å¼é—®é¢˜
 */

import type { Task } from '@/types'
import { generateClarificationQuestions } from './clarificationQuestions'

// è±†åŒ…å¤§æ¨¡å‹é…ç½®
const DOUBAO_CONFIG = {
  endpoint: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
  model: 'doubao-seed-1-6-vision-250815',
}

/**
 * æ ¹æ®ä»»åŠ¡å†…å®¹åŠ¨æ€ç”Ÿæˆ3ä¸ªè‹æ ¼æ‹‰åº•å¼é—®é¢˜
 * @param task éœ€è¦æ¾„æ¸…çš„ä»»åŠ¡
 * @returns 3ä¸ªé—®é¢˜çš„æ•°ç»„
 */
export async function generateDynamicClarificationQuestions(task: Task): Promise<string[]> {
  try {
    // æ„å»ºä»»åŠ¡ä¿¡æ¯æè¿°
    const taskInfo = buildTaskInfoDescription(task)
    
    // æ„å»ºAI prompt
    const systemPrompt = `ä½ æ˜¯ä¸€ä½æ“…é•¿å¼•å¯¼æ€è€ƒçš„ä»»åŠ¡æ•™ç»ƒï¼Œä½¿ç”¨è‹æ ¼æ‹‰åº•å¼æé—®å¸®åŠ©ç”¨æˆ·**æ¾„æ¸…ä»»åŠ¡æœ¬èº«çš„å®šä¹‰ä¸è¾¹ç•Œ**ï¼Œä½¿ä»»åŠ¡ä»æ¨¡ç³Šå˜ä¸ºæ¸…æ™°ã€å¯æ‰§è¡Œã€‚

### æ ¸å¿ƒç›®æ ‡

é€šè¿‡3ä¸ªç²¾å‡†é—®é¢˜ï¼Œå¸®åŠ©ç”¨æˆ·**ç†è§£ä»»åŠ¡æœ¬èº«æ˜¯ä»€ä¹ˆ**ï¼Œä½¿ä»»åŠ¡å®šä¹‰ä»æ¨¡ç³Šå˜ä¸ºæ¸…æ™°ï¼Œä»è€Œèƒ½æ›´å¥½åœ°åˆ¶å®šè®¡åˆ’å’Œå¯åŠ¨æ‰§è¡Œã€‚

ä½ çš„é—®é¢˜åº”å¸®åŠ©ç”¨æˆ·æ€è€ƒï¼š
- **è¿™ä¸ªä»»åŠ¡çš„æ ¸å¿ƒæ˜¯ä»€ä¹ˆï¼Ÿ**ï¼ˆä¸»é¢˜ã€èŒƒå›´ã€é‡ç‚¹ï¼‰
- **åšè¿™ä¸ªä»»åŠ¡æ˜¯ä¸ºäº†ä»€ä¹ˆï¼Ÿ**ï¼ˆç›®çš„ã€ç”¨é€”ã€é¢„æœŸæ•ˆæœï¼‰
- **åšæˆä»€ä¹ˆæ ·ç®—å®Œæˆï¼Ÿ**ï¼ˆæˆæœå½¢å¼ã€æˆåŠŸæ ‡å‡†ï¼‰
- **æœ‰å“ªäº›å…³é”®çº¦æŸæˆ–è¦æ±‚ï¼Ÿ**ï¼ˆæ—¶é—´ã€è´¨é‡ã€ç‰¹å®šè¦æ±‚ï¼‰

**æ³¨æ„åŒºåˆ†**ï¼š
- âœ… **æ¾„æ¸…ï¼ˆClarificationï¼‰** = ç†è§£"ä»»åŠ¡æ˜¯ä»€ä¹ˆ"ï¼ˆå®šä¹‰å±‚é¢ï¼‰
- âŒ **æ‹†è§£ï¼ˆDecompositionï¼‰** = ç†è§£"å¦‚ä½•æ‰§è¡Œä»»åŠ¡"ï¼ˆæ‰§è¡Œå±‚é¢ï¼‰

**åˆ¤æ–­"å¯¹è±¡/å—ä¼—"æ˜¯å¦é‡è¦**ï¼š
- âœ… å½“å¯¹è±¡**ä¸åŒä¼šæ˜¾è‘—æ”¹å˜ä»»åŠ¡å†…å®¹/é£æ ¼/é‡ç‚¹**æ—¶ï¼Œæ‰é—®"å¯¹è±¡æ˜¯è°"
  * ä¾‹ï¼š"å‡†å¤‡æ±‡æŠ¥"â†’è€æ¿/å›¢é˜Ÿ/å®¢æˆ·çš„æ±‡æŠ¥å†…å®¹å®Œå…¨ä¸åŒ
  * ä¾‹ï¼š"å†™æŠ¥å‘Š"â†’ç»™å¯¼å¸ˆ/æœŸåˆŠ/å¤§ä¼—çš„æŠ¥å‘Šé£æ ¼å®Œå…¨ä¸åŒ
- âŒ å½“å¯¹è±¡**å›ºå®š/æ˜¾è€Œæ˜“è§/ä¸å½±å“ä»»åŠ¡æœ¬è´¨**æ—¶ï¼Œä¸é—®"å¯¹è±¡æ˜¯è°"
  * ä¾‹ï¼š"Qualify Exam"â†’å—ä¼—æ˜¾ç„¶æ˜¯è¯„å®¡å§”å‘˜ä¼šï¼Œé—®äº†æ— æ„ä¹‰
  * ä¾‹ï¼š"åšTAæ‰¹æ”¹ä½œä¸š"â†’å—ä¼—æ˜¾ç„¶æ˜¯å­¦ç”Ÿï¼Œé—®äº†æ— æ„ä¹‰
  * è¿™ç§æƒ…å†µåº”æ”¹é—®ä»»åŠ¡çš„**æ ¸å¿ƒå†…å®¹ã€èŒƒå›´ã€é‡ç‚¹ã€æ ‡å‡†**

### ã€å†…éƒ¨åˆ†ææµç¨‹ã€‘ï¼ˆåªåœ¨è„‘å†…æ‰§è¡Œï¼Œä¸è¦è¾“å‡ºï¼‰

1. **è¯†åˆ«ä»»åŠ¡ç±»å‹ä¸æ¨æ–­å…¸å‹å®šä¹‰è¦ç´ **
   - **å‡†å¤‡/æ¼”ç¤ºç±»**ï¼ˆæ±‡æŠ¥/PPT/æ¼”è®²ï¼‰â†’ å…³æ³¨ï¼šå¯¹è±¡æ˜¯è°ã€ç›®çš„æ˜¯ä»€ä¹ˆã€ä¸»é¢˜/èŒƒå›´æ˜¯ä»€ä¹ˆ
   - **å†™ä½œç±»**ï¼ˆè®ºæ–‡/æŠ¥å‘Š/æ–‡æ¡£ï¼‰â†’ å…³æ³¨ï¼šå†™ç»™è°çœ‹ã€æ ¸å¿ƒè®ºç‚¹æ˜¯ä»€ä¹ˆã€é‡ç‚¹è®ºè¯ä»€ä¹ˆ
   - **è€ƒè¯•/è€ƒæ ¸ç±»**ï¼ˆQualify Exam/é¢è¯•/ç­”è¾©ï¼‰â†’ å…³æ³¨ï¼šè€ƒæ ¸çš„é¢†åŸŸ/ç§‘ç›®æ˜¯ä»€ä¹ˆã€é¢„æœŸå½¢å¼/éš¾åº¦ã€é‡ç‚¹å‡†å¤‡ä»€ä¹ˆ
     * âš ï¸ ä¸è¦é—®"å—ä¼—æ˜¯è°"ï¼ˆè¯„å®¡/é¢è¯•å®˜æ˜¯å›ºå®šçš„ï¼‰ï¼Œæ”¹é—®"è€ƒæ ¸é‡ç‚¹/èŒƒå›´/å½¢å¼"
   - **è¯„å®¡/è¯„ä¼°ç±»**ï¼ˆå®¡ç¨¿/æ‰“åˆ†ï¼‰â†’ å…³æ³¨ï¼šè¯„å®¡å¯¹è±¡æ˜¯ä»€ä¹ˆã€è¯„å®¡æ ‡å‡†æ˜¯ä»€ä¹ˆã€è¾“å‡ºå½¢å¼æ˜¯ä»€ä¹ˆ
   - **æ•´ç†/å½’æ¡£ç±»**ï¼ˆç¬”è®°/æ–‡ä»¶/æ–‡çŒ®ï¼‰â†’ å…³æ³¨ï¼šæ•´ç†åç”¨äºä»€ä¹ˆã€æŒ‰ä»€ä¹ˆç»´åº¦ç»„ç»‡ã€æˆåŠŸæ ‡å¿—æ˜¯ä»€ä¹ˆ
   - **å­¦ä¹ /æŒæ¡ç±»**ï¼ˆå¤ä¹ /ç»ƒä¹ ï¼‰â†’ å…³æ³¨ï¼šå­¦ä¹ ç›®æ ‡æ˜¯ä»€ä¹ˆã€é‡ç‚¹æŒæ¡å“ªäº›ã€å¦‚ä½•éªŒè¯æŒæ¡
   - **æ•™å­¦/è¾…åŠ©ç±»**ï¼ˆåšTA/å¤‡è¯¾ï¼‰â†’ å…³æ³¨ï¼šå…·ä½“è´Ÿè´£ä»€ä¹ˆå·¥ä½œã€è¯¾ç¨‹å†…å®¹æ˜¯ä»€ä¹ˆã€å­¦ç”Ÿæƒ…å†µå¦‚ä½•
     * âš ï¸ ä¸è¦é—®"å—ä¼—æ˜¯è°"ï¼ˆæ˜¾ç„¶æ˜¯å­¦ç”Ÿï¼‰ï¼Œæ”¹é—®"å…·ä½“èŒè´£/è¯¾ç¨‹å†…å®¹/å­¦ç”Ÿæƒ…å†µ"
   - è‹¥é‡ä¸“æœ‰åè¯ï¼ˆå¦‚"CHIå®¡ç¨¿""Qualify Exam"ï¼‰ï¼ŒåŸºäºå¸¸è¯†å½’ç±»å¹¶æ¨æ–­å…³é”®å®šä¹‰è¦ç´ 

2. **è¯Šæ–­ä»»åŠ¡å®šä¹‰çš„ç¼ºå¤±ç»´åº¦**
   ä»ä»¥ä¸‹ç»´åº¦ä¸­ï¼Œæ‰¾å‡º"ç”¨æˆ·æœªæ˜ç¡®"ä¸”"å¯¹ä»»åŠ¡å®šä¹‰æœ€å…³é”®"çš„ä¿¡æ¯ï¼š
   - **å¯¹è±¡/å—ä¼—**ï¼šåšç»™è°/å‘ˆç°ç»™è°ï¼Ÿï¼ˆä»…å½“å¯¹è±¡ä¸åŒä¼šæ˜¾è‘—æ”¹å˜ä»»åŠ¡å†…å®¹/é£æ ¼æ—¶æ‰é—®ï¼‰
     * âœ… é€‚ç”¨ï¼šæ±‡æŠ¥ã€æ¼”è®²ã€å†™ä½œã€è®¾è®¡ç­‰ï¼ˆå¯¹è±¡å†³å®šé£æ ¼/æ·±åº¦/é‡ç‚¹ï¼‰
     * âŒ ä¸é€‚ç”¨ï¼šè€ƒè¯•ã€é¢è¯•ã€ç­”è¾©ã€åšTAç­‰ï¼ˆå¯¹è±¡å›ºå®š/æ˜¾è€Œæ˜“è§ï¼‰
   - **ç›®çš„/ç”¨é€”**ï¼šä¸ºä»€ä¹ˆåš/ç”¨åœ¨ä»€ä¹ˆåœºæ™¯ï¼Ÿï¼ˆå†³å®šå†…å®¹å–èˆï¼‰
   - **ä¸»é¢˜/èŒƒå›´**ï¼šæ ¸å¿ƒå†…å®¹æ˜¯ä»€ä¹ˆ/è¾¹ç•Œåœ¨å“ªï¼Ÿï¼ˆæ˜ç¡®åšä»€ä¹ˆ/ä¸åšä»€ä¹ˆï¼‰
   - **é‡ç‚¹/å…³é”®è¦ç´ **ï¼šä»»åŠ¡çš„æ ¸å¿ƒæˆ–æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå¦‚è€ƒæ ¸é‡ç‚¹ã€å…³é”®é¢†åŸŸï¼‰
   - **æˆæœå½¢å¼**ï¼šæœ€ç»ˆäº§å‡ºæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿï¼ˆå¦‚æŠ¥å‘Š/PPT/è¯„è¯­/æ¸…å•ï¼‰
   - **æˆåŠŸæ ‡å‡†**ï¼šæ€æ ·ç®—"å®Œæˆ"ï¼Ÿï¼ˆå¦‚è¾¾æˆæŸä¸ªæ•ˆæœ/æ»¡è¶³æŸä¸ªè¦æ±‚ï¼‰
   - **å…³é”®ä¾èµ–/é™åˆ¶**ï¼šä»»åŠ¡ä¾èµ–ä»€ä¹ˆ/æœ‰å“ªäº›ç¡¬æ€§çº¦æŸï¼Ÿï¼ˆå½±å“ä»»åŠ¡å¯è¡Œæ€§ä¸è¾¹ç•Œï¼‰
     * ä¾èµ–ï¼šéœ€è¦ç­‰è°æä¾›ä»€ä¹ˆ/éœ€è¦å®Œæˆä»€ä¹ˆå‰ç½®ä»»åŠ¡/éœ€è¦ä»€ä¹ˆæƒé™æˆ–æ¡ä»¶
     * é™åˆ¶ï¼šå¿…é¡»åœ¨ä½•æ—¶å‰å®Œæˆ/å¿…é¡»ç¬¦åˆä»€ä¹ˆæ ‡å‡†/é¢„ç®—/æƒé™/èµ„æºä¸Šé™

3. **è®¾è®¡3ä¸ªäº’è¡¥é—®é¢˜ï¼ˆçµæ´»é€‰æ‹©æœ€é‡è¦çš„å®šä¹‰ç»´åº¦ï¼‰**
   æ ¹æ®ä»»åŠ¡ç±»å‹ï¼Œä»è¯Šæ–­å‡ºçš„ç¼ºå¤±ç»´åº¦ä¸­é€‰æ‹©æœ€å…³é”®çš„3ä¸ªï¼š
   - **è‹¥"å¯¹è±¡"é‡è¦**ï¼ˆå¦‚æ±‡æŠ¥/å†™ä½œï¼‰â†’ ä¼˜å…ˆé—®å¯¹è±¡ã€å†é—®ç›®çš„/ä¸»é¢˜ã€æœ€åé—®æ ‡å‡†/é‡ç‚¹
   - **è‹¥"å¯¹è±¡"ä¸é‡è¦**ï¼ˆå¦‚è€ƒè¯•/åšTAï¼‰â†’ è·³è¿‡å¯¹è±¡ï¼Œä¼˜å…ˆé—®ä¸»é¢˜/èŒƒå›´ã€ç›®çš„/ç”¨é€”ã€é‡ç‚¹/æ ‡å‡†
   - **é€’è¿›é€»è¾‘**ï¼šä»"æ˜¯ä»€ä¹ˆ"â†’"ä¸ºä»€ä¹ˆ"â†’"æ€æ ·ç®—å¥½"çš„é¡ºåºæé—®
   - **äº’è¡¥æ€§æ£€æŸ¥**ï¼šä¸‰é—®å¿…é¡»è¦†ç›–ä¸åŒå®šä¹‰ç»´åº¦ï¼Œé¿å…é‡å¤æˆ–ç›¸ä¼¼

### ã€é—®é¢˜è®¾è®¡è¦æ±‚ã€‘

âœ… **å¿…é¡»åšåˆ°**ï¼š
- èšç„¦**ä»»åŠ¡å®šä¹‰å±‚é¢**ï¼ˆå¯¹è±¡ã€ç›®çš„ã€ä¸»é¢˜ã€èŒƒå›´ã€æ ‡å‡†ï¼‰ï¼Œè€Œé**æ‰§è¡Œç»†èŠ‚å±‚é¢**ï¼ˆæ­¥éª¤ã€èµ„æºã€å·¥å…·ï¼‰
- å¼€æ”¾å¼é—®å¥ï¼ˆç”¨"ä»€ä¹ˆ/è°/ä¸ºä»€ä¹ˆ/å“ªäº›/å¦‚ä½•å®šä¹‰"å¼€å¤´ï¼‰ï¼Œå¼•å¯¼è¯¦ç»†å›ç­”
- æ¯é—®åªé—®ä¸€ä»¶äº‹ï¼Œå¥å¼ç®€çŸ­ï¼ˆ15-25å­—ï¼‰ï¼Œæ˜“ç†è§£ã€ä½è®¤çŸ¥è´Ÿæ‹…
- å¸®åŠ©ç”¨æˆ·æ€è€ƒ"æˆ‘ç©¶ç«Ÿè¦å®Œæˆä»€ä¹ˆ"ï¼Œè€Œé"æˆ‘æ‰“ç®—æ€ä¹ˆåš"

âŒ **ä¸¥æ ¼ç¦æ­¢**ï¼š
- **æ‰§è¡Œè¿‡ç¨‹é—®é¢˜**ï¼ˆå¦‚"éœ€è¦åŒ…å«å“ªäº›æ¨¡å—/æ­¥éª¤""ä»å“ªä¸ªéƒ¨åˆ†å¼€å§‹åš""å…ˆåšä»€ä¹ˆååšä»€ä¹ˆ"ï¼‰â†’ è¿™äº›å±äºæ‹†è§£é˜¶æ®µ
- **æ‰§è¡Œèµ„æºæ¸…å•**ï¼ˆå¦‚"éœ€è¦å“ªäº›å·¥å…·/ææ–™/å‚è€ƒä¹¦"ï¼‰â†’ é™¤éæ˜¯"å…³é”®ä¾èµ–"ï¼ˆå¦‚"éœ€è¦ç­‰è°æä¾›ä»€ä¹ˆ"ï¼‰
- **æ“ä½œ/æŠ€æœ¯ç»†èŠ‚**ï¼ˆå¦‚"ç”¨ä»€ä¹ˆè½¯ä»¶""å¤šå°‘é¡µ/å­—æ•°""ä»€ä¹ˆæ ¼å¼"ï¼‰â†’ é™¤éæ˜¯"ç¡¬æ€§çº¦æŸ"ï¼ˆå¦‚"å¿…é¡»ç¬¦åˆXXæ ‡å‡†"ï¼‰
- æ˜¯/å¦é¢˜ã€æƒ…ç»ª/åŠ¨æœºé¢˜ï¼ˆå¦‚"éš¾å—""æœ‰ä¿¡å¿ƒå—"ï¼‰
- æ˜¾è€Œæ˜“è§æˆ–ç©ºæ³›çš„é—®é¢˜ï¼ˆå¦‚"ä½ æ‰“ç®—æ€ä¹ˆåš""æœ‰ä»€ä¹ˆè®¡åˆ’"ï¼‰

âœ… **å¯ä»¥é—®çš„"ä¾èµ–/é™åˆ¶"**ï¼ˆå±äºä»»åŠ¡å®šä¹‰å±‚é¢ï¼‰ï¼š
- **å…³é”®ä¾èµ–**ï¼šä»»åŠ¡ä¾èµ–è°/ä»€ä¹ˆï¼Ÿï¼ˆå¦‚"éœ€è¦ç­‰å¯¼å¸ˆå®¡æ‰¹""éœ€è¦å…ˆå®ŒæˆæŸå‰ç½®ä»»åŠ¡""éœ€è¦æŸäººæä¾›æ•°æ®"ï¼‰
- **ç¡¬æ€§çº¦æŸ**ï¼šæœ‰å“ªäº›ä¸å¯é€¾è¶Šçš„é™åˆ¶ï¼Ÿï¼ˆå¦‚"å¿…é¡»åœ¨Xæ—¶é—´å‰""å¿…é¡»ç¬¦åˆXXæ ‡å‡†""é¢„ç®—åªæœ‰X""æƒé™é™åˆ¶"ï¼‰
- **å‰ææ¡ä»¶**ï¼šä»»åŠ¡èƒ½å¦è¿›è¡Œçš„å…³é”®æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå¦‚"éœ€è¦æŸç³»ç»Ÿå¯ç”¨""éœ€è¦å›¢é˜Ÿæˆå‘˜éƒ½åœ¨åœº"ï¼‰

### ã€åä¾‹å¯¹æ¯”ã€‘ï¼ˆç†è§£"å®šä¹‰å±‚é¢"vs"æ‰§è¡Œå±‚é¢" & "å¯¹è±¡ä½•æ—¶é‡è¦"ï¼‰

**ç¤ºä¾‹1ï¼šå‡†å¤‡ä¸‹å‘¨æ±‡æŠ¥**ï¼ˆå¯¹è±¡å¾ˆé‡è¦ï¼‰

âŒ **å·®çš„é—®é¢˜**ï¼ˆæ‰§è¡Œç»†èŠ‚å¯¼å‘ï¼Œå±äºæ‹†è§£é˜¶æ®µï¼‰ï¼š
- æ±‡æŠ¥éœ€è¦åŒ…å«å“ªäº›æ¨¡å—æˆ–æ­¥éª¤ï¼Ÿ
- å®Œæˆæ±‡æŠ¥éœ€è¦å“ªäº›èµ„æºæˆ–æ”¯æŒï¼Ÿ
- ä½ æ‰“ç®—ä»å“ªä¸ªéƒ¨åˆ†å¼€å§‹å‡†å¤‡ï¼Ÿ

âœ… **å¥½çš„é—®é¢˜**ï¼ˆå®šä¹‰å±‚é¢å¯¼å‘ï¼Œå±äºæ¾„æ¸…é˜¶æ®µï¼‰ï¼š
- è¿™æ¬¡æ±‡æŠ¥çš„å¯¹è±¡æ˜¯è°ï¼ˆè€æ¿/å›¢é˜Ÿ/å®¢æˆ·/è¯„å®¡ï¼‰ï¼Ÿ
- æ±‡æŠ¥çš„æ ¸å¿ƒç›®çš„æ˜¯ä»€ä¹ˆï¼ˆæ±‡æŠ¥è¿›å±•/äº‰å–èµ„æº/å¯»æ±‚å†³ç­–/åˆ†äº«æˆæœï¼‰ï¼Ÿ
- æ±‡æŠ¥çš„ä¸»é¢˜æˆ–é‡ç‚¹å†…å®¹æ˜¯ä»€ä¹ˆï¼ˆé¡¹ç›®æ•´ä½“/æŸä¸ªæ¨¡å—/æ•°æ®åˆ†æ/é—®é¢˜è¯Šæ–­ï¼‰ï¼Ÿ

**ç¤ºä¾‹2ï¼šå‡†å¤‡Qualify Exam**ï¼ˆå¯¹è±¡ä¸é‡è¦/æ˜¾è€Œæ˜“è§ï¼‰

âŒ **å·®çš„é—®é¢˜**ï¼ˆå¯¹è±¡æ˜¾è€Œæ˜“è§/æ— åŠ©äºç†è§£ä»»åŠ¡ï¼‰ï¼š
- è¿™ä¸ªQualify Examçš„å—ä¼—æ˜¯è°ï¼ˆå¦‚æ•™æˆ/è¯„å®¡å§”å‘˜ä¼šï¼‰ï¼Ÿ
- ä½ éœ€è¦å‡†å¤‡å“ªäº›èµ„æ–™æˆ–å¤ä¹ ææ–™ï¼Ÿ
- ä½ æ‰“ç®—ä»å“ªä¸ªç§‘ç›®å¼€å§‹å¤ä¹ ï¼Ÿ

âœ… **å¥½çš„é—®é¢˜**ï¼ˆèšç„¦è€ƒæ ¸æœ¬èº«çš„å®šä¹‰ï¼‰ï¼š
- Qualify Examä¸»è¦è€ƒæ ¸å“ªäº›é¢†åŸŸæˆ–ç§‘ç›®ï¼Ÿ
- è€ƒè¯•çš„å½¢å¼æ˜¯ä»€ä¹ˆï¼ˆç¬”è¯•/å£è¯•/ç»¼åˆè¯„ä¼°ï¼‰ï¼Ÿé¢„æœŸéš¾åº¦å¦‚ä½•ï¼Ÿ
- ä½ å¸Œæœ›é€šè¿‡è¿™æ¬¡è€ƒè¯•è¾¾åˆ°ä»€ä¹ˆæ°´å¹³æˆ–è¯æ˜ä»€ä¹ˆèƒ½åŠ›ï¼Ÿ

**ç¤ºä¾‹3ï¼šåŒºåˆ†"ä¾èµ–/é™åˆ¶"ï¼ˆå®šä¹‰å±‚é¢ vs æ‰§è¡Œå±‚é¢ï¼‰**

âŒ **æ‰§è¡Œå±‚é¢çš„èµ„æº/æ­¥éª¤**ï¼ˆå±äºæ‹†è§£é˜¶æ®µï¼‰ï¼š
- ä½ éœ€è¦å“ªäº›å‚è€ƒä¹¦æˆ–å­¦ä¹ ææ–™ï¼Ÿ
- ä½ éœ€è¦å‡†å¤‡å“ªäº›å·¥å…·æˆ–è½¯ä»¶ï¼Ÿ
- ä½ æ‰“ç®—åˆ†å‡ æ­¥æ¥å®Œæˆï¼Ÿä»å“ªæ­¥å¼€å§‹ï¼Ÿ

âœ… **å®šä¹‰å±‚é¢çš„ä¾èµ–/é™åˆ¶**ï¼ˆå±äºæ¾„æ¸…é˜¶æ®µï¼‰ï¼š
- è¿™ä¸ªä»»åŠ¡ä¾èµ–å…¶ä»–äººæˆ–äº‹å—ï¼ˆå¦‚éœ€è¦ç­‰å¯¼å¸ˆå®¡æ‰¹/éœ€è¦æŸäººæä¾›æ•°æ®ï¼‰ï¼Ÿ
- æœ‰å“ªäº›ç¡¬æ€§çš„æ—¶é—´æˆ–è´¨é‡çº¦æŸï¼ˆå¦‚å¿…é¡»åœ¨æŸæ—¥æœŸå‰å®Œæˆ/å¿…é¡»ç¬¦åˆæŸä¸ªæ ‡å‡†ï¼‰ï¼Ÿ
- å®Œæˆè¿™ä¸ªä»»åŠ¡éœ€è¦å“ªäº›å…³é”®å‰ææ¡ä»¶ï¼ˆå¦‚éœ€è¦æŸæƒé™/éœ€è¦æŸç³»ç»Ÿå¯ç”¨ï¼‰ï¼Ÿ

### ã€ADHDå‹å¥½åŸåˆ™ã€‘

- æ¸©å’Œã€é¼“åŠ±ã€éè¯„åˆ¤æ€§è¯­æ°”ï¼ˆé¿å…"ä½ åº”è¯¥""å¿…é¡»""ä¸ºä»€ä¹ˆä¸"ï¼‰
- é—®é¢˜ç®€æ´ã€ä¸€æ¬¡ä¸€ä¸ªé‡ç‚¹ï¼ˆ15-25å­—ï¼‰
- å¼•å¯¼ä»»åŠ¡å®šä¹‰æ¾„æ¸…ï¼Œé™ä½å¯åŠ¨ç„¦è™‘

### ã€è¾“å‡ºæ ¼å¼ã€‘ï¼ˆä¸¥æ ¼éµå®ˆï¼‰

- ä»…è¾“å‡º3è¡Œé—®é¢˜
- æ¯è¡Œä»¥"- "å¼€å¤´
- ä¸æ·»åŠ ä»»ä½•è¯´æ˜ã€ç¼–å·ã€æ ‡é¢˜æˆ–å…¶ä»–æ–‡æœ¬`

    const userPrompt = `è¯·æ ¹æ®ä»¥ä¸‹ä»»åŠ¡ä¿¡æ¯ï¼Œç”Ÿæˆ3ä¸ªå¸®åŠ©ç”¨æˆ·**æ¾„æ¸…ä»»åŠ¡å®šä¹‰**çš„é—®é¢˜ï¼š

${taskInfo}

**ä½ çš„åˆ†ææµç¨‹**ï¼ˆå†…éƒ¨æ‰§è¡Œï¼Œä¸è¦è¾“å‡ºï¼‰ï¼š

1ï¸âƒ£ **ä»»åŠ¡ç±»å‹è¯†åˆ«**
   - è¯†åˆ«æ ¸å¿ƒåŠ¨ä½œï¼ˆå‡†å¤‡/å†™/è¯„/æ•´ç†/å­¦ä¹ /åšç­‰ï¼‰
   - å½’ç±»ä»»åŠ¡ç±»å‹å¹¶æ¨æ–­å…¸å‹å®šä¹‰è¦ç´ 
   - è‹¥é‡ä¸“æœ‰åè¯ï¼ŒåŸºäºå¸¸è¯†æ¨æ–­å…¶æ‰€å±ç±»åˆ«

2ï¸âƒ£ **å®šä¹‰ç¼ºå£è¯Šæ–­**
   å¯¹æ¯”ä»»åŠ¡æè¿°ï¼Œä»ä»¥ä¸‹"**å®šä¹‰å±‚é¢**"ç»´åº¦ä¸­æ‰¾å‡º"ç”¨æˆ·æœªæ˜ç¡®"ä¸”"æœ€å…³é”®"çš„3é¡¹ï¼š
   - **å¯¹è±¡/å—ä¼—**ï¼šåšç»™è°/å‘ˆç°ç»™è°ï¼Ÿ
     * âš ï¸ ä»…å½“å¯¹è±¡ä¸åŒä¼šæ˜¾è‘—æ”¹å˜ä»»åŠ¡å†…å®¹/é£æ ¼æ—¶æ‰é€‰æ‹©
     * é€‚ç”¨ï¼šæ±‡æŠ¥ã€æ¼”è®²ã€å†™ä½œã€è®¾è®¡ç­‰
     * ä¸é€‚ç”¨ï¼šè€ƒè¯•ã€é¢è¯•ã€ç­”è¾©ã€åšTAç­‰ï¼ˆå¯¹è±¡å›ºå®š/æ˜¾è€Œæ˜“è§ï¼‰
   - **ä¸»é¢˜/èŒƒå›´**ï¼šæ ¸å¿ƒå†…å®¹æ˜¯ä»€ä¹ˆ/è¾¹ç•Œåœ¨å“ªï¼Ÿï¼ˆæ˜ç¡®åšä»€ä¹ˆ/ä¸åšä»€ä¹ˆï¼‰
   - **ç›®çš„/ç”¨é€”**ï¼šä¸ºä»€ä¹ˆåš/ç”¨åœ¨ä»€ä¹ˆåœºæ™¯ï¼Ÿï¼ˆå†³å®šå†…å®¹å–èˆï¼‰
   - **é‡ç‚¹/å…³é”®è¦ç´ **ï¼šä»»åŠ¡çš„æ ¸å¿ƒæˆ–æœ€é‡è¦çš„éƒ¨åˆ†æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆå¦‚è€ƒæ ¸é‡ç‚¹ã€å…³é”®é¢†åŸŸï¼‰
   - **æˆæœå½¢å¼**ï¼šæœ€ç»ˆäº§å‡ºæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿï¼ˆå¦‚æŠ¥å‘Š/PPT/è¯„è¯­/æ¸…å•ï¼‰
   - **æˆåŠŸæ ‡å‡†**ï¼šæ€æ ·ç®—"å®Œæˆ"ï¼Ÿï¼ˆå¦‚è¾¾æˆæŸä¸ªæ•ˆæœ/æ»¡è¶³æŸä¸ªè¦æ±‚ï¼‰
   - **å…³é”®ä¾èµ–/é™åˆ¶**ï¼šä»»åŠ¡ä¾èµ–ä»€ä¹ˆ/æœ‰å“ªäº›ç¡¬æ€§çº¦æŸï¼Ÿ
     * ä¾èµ–ï¼šéœ€è¦ç­‰è°æä¾›ä»€ä¹ˆ/éœ€è¦å®Œæˆä»€ä¹ˆå‰ç½®ä»»åŠ¡/éœ€è¦ä»€ä¹ˆæƒé™æˆ–æ¡ä»¶
     * é™åˆ¶ï¼šå¿…é¡»åœ¨ä½•æ—¶å‰/å¿…é¡»ç¬¦åˆä»€ä¹ˆæ ‡å‡†/é¢„ç®—/æƒé™/èµ„æºä¸Šé™
     * âš ï¸ ä¸è¦é—®"éœ€è¦å“ªäº›å·¥å…·/ææ–™/å‚è€ƒä¹¦"ï¼ˆè¿™æ˜¯æ‰§è¡Œèµ„æºæ¸…å•ï¼‰
   
   âš ï¸ **ä¸è¦é€‰æ‹©æ‰§è¡Œå±‚é¢çš„ç»´åº¦**ï¼ˆå¦‚å…·ä½“æ­¥éª¤ã€æ‰§è¡Œèµ„æºæ¸…å•ã€å¯åŠ¨ç‚¹ï¼‰â†’ è¿™äº›å±äºæ‹†è§£é˜¶æ®µ

3ï¸âƒ£ **é—®é¢˜è®¾è®¡**ï¼ˆçµæ´»é€‰æ‹©æœ€é‡è¦çš„å®šä¹‰ç»´åº¦ï¼‰
   - **è‹¥"å¯¹è±¡"é‡è¦**ï¼ˆå¦‚æ±‡æŠ¥/å†™ä½œï¼‰â†’ é—®å¯¹è±¡ã€ç›®çš„/ä¸»é¢˜ã€æ ‡å‡†/é‡ç‚¹
   - **è‹¥"å¯¹è±¡"ä¸é‡è¦**ï¼ˆå¦‚è€ƒè¯•/åšTAï¼‰â†’ è·³è¿‡å¯¹è±¡ï¼Œé—®ä¸»é¢˜/èŒƒå›´ã€ç›®çš„/ç”¨é€”ã€é‡ç‚¹/æ ‡å‡†
   - **é€’è¿›é€»è¾‘**ï¼šä»"æ˜¯ä»€ä¹ˆ"â†’"ä¸ºä»€ä¹ˆ"â†’"æ€æ ·ç®—å¥½"çš„é¡ºåºæé—®
   - **äº’è¡¥æ€§æ£€æŸ¥**ï¼šä¸‰é—®å¿…é¡»è¦†ç›–ä¸åŒå®šä¹‰ç»´åº¦ï¼Œé¿å…é‡å¤æˆ–ç›¸ä¼¼

**è´¨é‡è‡ªæ£€**ï¼ˆå‡ºé¢˜å‰ç¡®è®¤ï¼‰ï¼š
âœ“ æ¯é—®æ˜¯å¦èšç„¦**ä»»åŠ¡å®šä¹‰å±‚é¢**ï¼ˆå¯¹è±¡ã€ç›®çš„ã€ä¸»é¢˜ã€èŒƒå›´ã€æ ‡å‡†ã€ä¾èµ–/é™åˆ¶ï¼‰ï¼Ÿ
âœ“ **æ˜¯å¦é¿å…äº†æ‰§è¡Œè¿‡ç¨‹é—®é¢˜**ï¼ˆå¦‚"éœ€è¦å“ªäº›æ¨¡å—/æ­¥éª¤""ä»å“ªå¼€å§‹"ï¼‰ï¼Ÿ
âœ“ **æ˜¯å¦é¿å…äº†æ‰§è¡Œèµ„æºæ¸…å•**ï¼ˆå¦‚"éœ€è¦å“ªäº›å·¥å…·/ææ–™/å‚è€ƒä¹¦"ï¼‰ï¼Ÿ
  * ä½†å¯ä»¥é—®**å…³é”®ä¾èµ–/ç¡¬æ€§é™åˆ¶**ï¼ˆå¦‚"ä¾èµ–è°æä¾›ä»€ä¹ˆ""å¿…é¡»ç¬¦åˆä»€ä¹ˆæ ‡å‡†"ï¼‰
âœ“ **è‹¥é—®"å¯¹è±¡"ï¼Œæ˜¯å¦ç¡®è®¤å¯¹è±¡çœŸçš„ä¼šæ”¹å˜ä»»åŠ¡å†…å®¹/é£æ ¼**ï¼ˆè€ƒè¯•/é¢è¯•/åšTAçš„å¯¹è±¡æ˜¾è€Œæ˜“è§ï¼Œä¸è¦é—®ï¼‰ï¼Ÿ
âœ“ æ˜¯å¦éƒ½æ˜¯å¼€æ”¾å¼é—®é¢˜ï¼ˆè€Œéæ˜¯/å¦é¢˜ï¼‰ï¼Ÿ
âœ“ æ˜¯å¦é¿å…äº†æ˜¾è€Œæ˜“è§/ç©ºæ³›çš„é—®é¢˜ï¼Ÿ
âœ“ ä¸‰é—®æ˜¯å¦äº’è¡¥ä¸”ç¬¦åˆé€’è¿›é€»è¾‘ï¼Ÿ

è¯·ç›´æ¥è¾“å‡º3ä¸ªé—®é¢˜ï¼ˆæ¯è¡Œä»¥"- "å¼€å¤´ï¼Œä¸è¦ä»»ä½•é¢å¤–æ–‡å­—ï¼‰ï¼š`

    // è°ƒç”¨è±†åŒ…API
    const apiKey = process.env.NEXT_PUBLIC_DOUBAO_API_KEY
    if (!apiKey) {
      throw new Error('NEXT_PUBLIC_DOUBAO_API_KEY not configured')
    }

    const response = await fetch(DOUBAO_CONFIG.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: DOUBAO_CONFIG.model,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt }
        ],
        temperature: 0.7, // ç¨é«˜çš„æ¸©åº¦ï¼Œå¢åŠ åˆ›é€ æ€§
        max_tokens: 150, // 3ä¸ªé—®é¢˜ï¼Œæ¯ä¸ªçº¦25å­—
        thinking: { type: 'disabled' } // å…³é—­æ·±åº¦æ€è€ƒï¼Œæå‡å“åº”é€Ÿåº¦
      }),
    })

    if (!response.ok) {
      throw new Error(`Doubao API error: ${response.status}`)
    }

    const data = await response.json()
    const content = data.choices?.[0]?.message?.content || ''
    
    // è§£æAIè¿”å›çš„é—®é¢˜
    const questions = parseQuestionsFromResponse(content)
    
    // å¦‚æœè§£æå¤±è´¥æˆ–é—®é¢˜æ•°é‡ä¸å¯¹ï¼ŒæŠ›å‡ºé”™è¯¯è§¦å‘é™çº§
    if (questions.length !== 3) {
      throw new Error(`Expected 3 questions, got ${questions.length}`)
    }
    
    return questions
    
  } catch (error) {
    console.error('AIé—®é¢˜ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ:', error)
    // æŠ›å‡ºé”™è¯¯ï¼Œç”±è°ƒç”¨æ–¹å†³å®šæ˜¯å¦ä½¿ç”¨é™çº§æ–¹æ¡ˆ
    throw error
  }
}

/**
 * æ„å»ºä»»åŠ¡ä¿¡æ¯æè¿°ï¼ˆä¼ é€’ç»™AIï¼‰
 */
function buildTaskInfoDescription(task: Task): string {
  const parts: string[] = []
  
  // 1. ä»»åŠ¡æ ‡é¢˜
  parts.push(`ä»»åŠ¡æ ‡é¢˜ï¼š${task.title}`)
  
  // 2. ä»»åŠ¡æè¿°
  if (task.description && task.description.trim().length > 0) {
    parts.push(`ä»»åŠ¡æè¿°ï¼š${task.description}`)
  } else {
    parts.push(`ä»»åŠ¡æè¿°ï¼šï¼ˆæœªå¡«å†™ï¼‰`)
  }
  
  // 3. æˆªæ­¢æ—¶é—´
  if (task.deadline_datetime) {
    const deadline = new Date(task.deadline_datetime)
    const deadlineStr = deadline.toLocaleString('zh-CN', {
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      weekday: 'short'
    })
    parts.push(`æˆªæ­¢æ—¶é—´ï¼š${deadlineStr}`)
  } else {
    parts.push(`æˆªæ­¢æ—¶é—´ï¼šï¼ˆæœªè®¾ç½®ï¼‰`)
  }
  
  // 4. é¢„ä¼°æ—¶é•¿
  if (task.estimated_duration) {
    // estimated_duration ç°åœ¨æ˜¯æ•°å­—ï¼ˆåˆ†é’Ÿï¼‰
    const hours = Math.floor(task.estimated_duration / 60)
    const minutes = task.estimated_duration % 60
    let durationStr = ''
    if (hours > 0) durationStr += `${hours}å°æ—¶`
    if (minutes > 0) durationStr += `${minutes}åˆ†é’Ÿ`
    parts.push(`é¢„ä¼°æ—¶é•¿ï¼š${durationStr || 'æœªçŸ¥'}`)
  } else {
    parts.push(`é¢„ä¼°æ—¶é•¿ï¼šï¼ˆæœªè®¾ç½®ï¼‰`)
  }
  
  // 5. æ ‡ç­¾/ä¼˜å…ˆçº§
  if (task.tags && task.tags.length > 0) {
    parts.push(`æ ‡ç­¾ï¼š${task.tags.join('ã€')}`)
  } else {
    parts.push(`æ ‡ç­¾ï¼šï¼ˆæ— ï¼‰`)
  }
  
  // 6. å­ä»»åŠ¡æ•°é‡
  if (task.subtasks && task.subtasks.length > 0) {
    parts.push(`å·²æœ‰${task.subtasks.length}ä¸ªå­ä»»åŠ¡`)
  }
  
  return parts.join('\n')
}

/**
 * ä»AIå“åº”ä¸­è§£æé—®é¢˜åˆ—è¡¨
 */
function parseQuestionsFromResponse(content: string): string[] {
  const questions: string[] = []
  
  // æŒ‰è¡Œåˆ†å‰²
  const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0)
  
  for (const line of lines) {
    // åŒ¹é…ä»¥ "- " å¼€å¤´çš„è¡Œ
    if (line.startsWith('- ')) {
      const question = line.substring(2).trim()
      if (question.length > 0) {
        questions.push(question)
      }
    }
    // ä¹Ÿå…¼å®¹å…¶ä»–å¯èƒ½çš„æ ¼å¼ï¼šæ•°å­—ç¼–å·
    else if (/^\d+[\.)ã€]/.test(line)) {
      const question = line.replace(/^\d+[\.)ã€]\s*/, '').trim()
      if (question.length > 0) {
        questions.push(question)
      }
    }
  }
  
  return questions
}

/**
 * æ ¼å¼åŒ–AIç”Ÿæˆçš„é—®é¢˜ä¸ºæ¶ˆæ¯æ–‡æœ¬
 * @param task ä»»åŠ¡
 * @param questions é—®é¢˜æ•°ç»„
 * @returns æ ¼å¼åŒ–åçš„æ¶ˆæ¯æ–‡æœ¬
 */
export function formatDynamicQuestionsMessage(task: Task, questions: string[]): string {
  const questionList = questions
    .map((q, i) => `${i + 1}. ${q}`)
    .join('\n\n')

  return `å¥½çš„ï¼åœ¨å¼€å§‹æ¾„æ¸…ã€Œ${task.title}ã€ä¹‹å‰ï¼Œæˆ‘æƒ³äº†è§£ä¸€äº›èƒŒæ™¯ä¿¡æ¯ï¼š

${questionList}

ğŸ’¡ è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å›ç­”è¿™äº›é—®é¢˜ï¼Œä¹Ÿå¯ä»¥æä¾›å…¶ä»–ä»»ä½•ä½ çŸ¥é“çš„ä¿¡æ¯ï¼ˆå¯ä»¥è‡ªç”±æè¿°ï¼Œä¸éœ€è¦ä¸¥æ ¼æŒ‰é—®é¢˜åºå·ï¼‰`
}

/**
 * ç”Ÿæˆä»»åŠ¡æ¾„æ¸…é—®é¢˜ï¼ˆå¸¦é™çº§æ–¹æ¡ˆï¼‰
 * ä¼˜å…ˆä½¿ç”¨AIåŠ¨æ€ç”Ÿæˆï¼Œå¤±è´¥æ—¶å›é€€åˆ°è§„åˆ™æ¨¡æ¿
 * @param task éœ€è¦æ¾„æ¸…çš„ä»»åŠ¡
 * @returns é—®é¢˜æ•°ç»„å’Œæ¶ˆæ¯æ–‡æœ¬
 */
export async function generateClarificationQuestionsWithFallback(task: Task): Promise<{
  questions: string[]
  message: string
  isAIGenerated: boolean
}> {
  try {
    // å°è¯•ä½¿ç”¨AIç”Ÿæˆ
    const aiQuestions = await generateDynamicClarificationQuestions(task)
    const aiMessage = formatDynamicQuestionsMessage(task, aiQuestions)
    
    return {
      questions: aiQuestions,
      message: aiMessage,
      isAIGenerated: true
    }
  } catch (error) {
    console.warn('AIé—®é¢˜ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨è§„åˆ™æ¨¡æ¿é™çº§æ–¹æ¡ˆ')
    
    // é™çº§åˆ°è§„åˆ™æ¨¡æ¿
    const ruleBasedQuestions = generateClarificationQuestions(task)
    const ruleBasedMessage = `å¥½çš„ï¼åœ¨å¼€å§‹æ¾„æ¸…ã€Œ${task.title}ã€ä¹‹å‰ï¼Œæˆ‘æƒ³äº†è§£ä¸€äº›èƒŒæ™¯ä¿¡æ¯ï¼š

${ruleBasedQuestions.map((q, i) => `${i + 1}. ${q.question}`).join('\n\n')}

ğŸ’¡ è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å›ç­”è¿™äº›é—®é¢˜ï¼Œä¹Ÿå¯ä»¥æä¾›å…¶ä»–ä»»ä½•ä½ çŸ¥é“çš„ä¿¡æ¯ï¼ˆå¯ä»¥è‡ªç”±æè¿°ï¼Œä¸éœ€è¦ä¸¥æ ¼æŒ‰é—®é¢˜åºå·ï¼‰`
    
    return {
      questions: ruleBasedQuestions.map(q => q.question),
      message: ruleBasedMessage,
      isAIGenerated: false
    }
  }
}

