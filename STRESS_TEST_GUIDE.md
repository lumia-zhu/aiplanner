# 🔥 压力测试指南

## 📋 测试概述

本压力测试旨在验证系统能否稳定处理 **20个并发用户** 的同时操作，测试持续时间为 **60秒**。

### 测试场景

每个模拟用户会随机执行以下操作（每2秒一次）：
- **40%** - 创建新任务
- **40%** - 查询任务列表
- **20%** - 更新任务状态

## 🚀 如何运行测试

### 方法1：使用启动脚本（推荐）

```bash
cd task-manager
node run-stress-test.js
```

### 方法2：直接运行

```bash
cd task-manager
node stress-test.js
```

**注意**：方法2需要手动设置环境变量。

## 📊 测试报告解读

### 关键指标

#### 1. **总体指标**
- **总请求数**：测试期间发送的请求总数
- **成功请求**：HTTP状态码 2xx 的请求数
- **失败请求**：非 2xx 状态码或超时的请求数
- **成功率**：成功请求 / 总请求数 × 100%
- **请求速率**：总请求数 / 测试时长（req/s）

#### 2. **响应时间指标**
- **平均响应时间**：所有请求的平均耗时
- **最小响应时间**：最快的请求耗时
- **最大响应时间**：最慢的请求耗时
- **P50（中位数）**：50%的请求在此时间内完成
- **P95**：95%的请求在此时间内完成
- **P99**：99%的请求在此时间内完成

#### 3. **请求类型分布**
- **create_task**：创建任务的请求数
- **get_tasks**：查询任务列表的请求数
- **update_task**：更新任务状态的请求数

### 性能标准

#### ✅ 优秀（推荐生产部署）
- 成功率 ≥ 99%
- 平均响应时间 < 200ms
- P95响应时间 < 500ms
- P99响应时间 < 1000ms

#### ⚠️ 良好（可接受，建议优化）
- 成功率 ≥ 95%
- 平均响应时间 < 500ms
- P95响应时间 < 1000ms
- P99响应时间 < 2000ms

#### ❌ 需要优化
- 成功率 < 95%
- 平均响应时间 > 500ms
- P99响应时间 > 2000ms

## 🔍 潜在瓶颈分析

### 1. **数据库层面**
- **Supabase免费层限制**：
  - 并发连接数：最多60个
  - API请求：每分钟200次（受免费层限制）
  - 数据库大小：最多500MB
  
- **优化建议**：
  - 添加数据库索引（已在schema中配置）
  - 使用数据库连接池
  - 考虑升级到Pro计划

### 2. **API层面**
- **Next.js API Routes**：
  - Vercel免费层：10秒超时限制
  - 并发执行限制：取决于Vercel计划
  
- **优化建议**：
  - 使用边缘函数（Edge Functions）
  - 实现请求缓存
  - 添加CDN缓存

### 3. **AI服务层面**
- **豆包API**：
  - 速率限制：取决于API密钥配额
  - 响应时间：通常200-2000ms
  
- **优化建议**：
  - 实现请求队列
  - 添加重试机制
  - 考虑流式响应

### 4. **前端层面**
- **浏览器并发限制**：
  - 同域名最多6-8个并发请求
  
- **优化建议**：
  - 使用Service Worker
  - 实现乐观更新
  - 添加本地缓存

## 🛠️ 故障排查

### 常见问题

#### 1. "未配置 Supabase URL 或 API Key"
**原因**：环境变量未加载

**解决**：
```bash
# 确认 .env.local 文件存在
ls -la task-manager/.env.local

# 检查文件内容
cat task-manager/.env.local

# 使用启动脚本运行
node task-manager/run-stress-test.js
```

#### 2. 大量请求失败（失败率 > 50%）
**可能原因**：
- Supabase API速率限制
- 数据库连接数达到上限
- 网络问题

**解决**：
```javascript
// 在 stress-test.js 中调整参数
const CONFIG = {
  CONCURRENT_USERS: 10,  // 降低并发数
  REQUEST_INTERVAL_MS: 3000,  // 增加请求间隔
};
```

#### 3. 响应时间异常长（P99 > 5000ms）
**可能原因**：
- 数据库查询未使用索引
- API函数执行时间过长
- 网络延迟高

**调试**：
```bash
# 查看详细错误信息
node run-stress-test.js 2>&1 | tee stress-test.log

# 分析错误模式
grep "error" stress-test.log
```

## 📈 测试结果示例

### 示例1：理想情况（优秀性能）

```
============================================================
📊 压力测试报告
============================================================

测试配置:
  - 并发用户数: 20
  - 测试时长: 60秒
  - 请求间隔: 2000ms

总体指标:
  - 总请求数: 580
  - 成功请求: 577 (99.48%)
  - 失败请求: 3
  - 请求速率: 9.67 req/s

响应时间 (ms):
  - 平均: 156ms
  - 最小: 45ms
  - 最大: 890ms
  - P50: 142ms
  - P95: 324ms
  - P99: 657ms

请求类型分布:
  - create_task: 232 次
  - get_tasks: 234 次
  - update_task: 114 次

============================================================
✅ 测试通过！系统表现良好
============================================================
```

**分析**：系统表现优秀，可以稳定支持20个并发用户。

### 示例2：需要优化（性能瓶颈）

```
============================================================
📊 压力测试报告
============================================================

测试配置:
  - 并发用户数: 20
  - 测试时长: 60秒
  - 请求间隔: 2000ms

总体指标:
  - 总请求数: 580
  - 成功请求: 512 (88.28%)
  - 失败请求: 68
  - 请求速率: 9.67 req/s

响应时间 (ms):
  - 平均: 1245ms
  - 最小: 89ms
  - 最大: 8934ms
  - P50: 876ms
  - P95: 3456ms
  - P99: 6789ms

请求类型分布:
  - create_task: 232 次
  - get_tasks: 234 次
  - update_task: 114 次

❌ 错误汇总:
  1. [create_task] User stress_test_user_abc: Status 429
  2. [get_tasks] User stress_test_user_def: Status 429
  ...

============================================================
❌ 测试失败：大量请求失败，需要紧急处理
============================================================
```

**分析**：系统遇到性能瓶颈，可能是API速率限制（429错误）或数据库连接问题。

## 🎯 优化建议

### 短期优化（1-2天）
1. **添加请求缓存**
   ```typescript
   // 缓存任务列表，减少数据库查询
   const cache = new Map();
   ```

2. **实现乐观更新**
   ```typescript
   // 先更新UI，后台同步数据库
   setTasks(prev => [...prev, newTask]);
   await saveToDatabase(newTask);
   ```

3. **添加错误重试**
   ```typescript
   // API调用失败时自动重试
   const result = await retryWithBackoff(apiCall, 3);
   ```

### 中期优化（1周）
1. **升级Supabase计划**
   - Pro计划：更高的API速率限制
   - 更多并发连接数
   - 更好的性能保障

2. **实现数据库连接池**
   ```typescript
   // 使用pg-pool管理数据库连接
   const pool = new Pool({ max: 20 });
   ```

3. **添加CDN缓存**
   - 静态资源使用CDN
   - API响应添加缓存头

### 长期优化（1个月）
1. **微服务架构**
   - 将AI服务独立部署
   - 使用消息队列处理异步任务

2. **读写分离**
   - 使用Supabase的读副本
   - 降低主数据库负载

3. **实现分布式缓存**
   - 使用Redis缓存热点数据
   - 减少数据库查询

## 📝 测试日志

### 如何保存测试结果

```bash
# 将测试结果保存到文件
node run-stress-test.js > stress-test-$(date +%Y%m%d-%H%M%S).log 2>&1

# 查看历史测试结果
ls -lh stress-test-*.log
```

### 自动化测试

可以将压力测试集成到CI/CD流程中：

```yaml
# .github/workflows/stress-test.yml
name: Stress Test
on:
  schedule:
    - cron: '0 0 * * 0'  # 每周日运行
  workflow_dispatch:  # 手动触发

jobs:
  stress-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
      - run: npm install
      - run: node task-manager/run-stress-test.js
```

## 🤝 反馈与改进

如果测试发现问题或有改进建议，请：
1. 记录详细的错误信息和日志
2. 注明测试环境和配置
3. 提供测试结果报告

---

**最后更新**: 2025-01-23
**版本**: 1.0.0

