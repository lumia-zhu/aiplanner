# 任务拆解AI升级文档

## 📋 改造概述

本次改造优化了"任务拆解"功能，从固定规则问题改为AI动态生成拆解引导问题，与"任务澄清"功能保持一致的交互体验。

---

## 🎯 改造目标

将任务拆解的固定问题模板改为AI根据任务内容动态生成，提升问题的针对性和用户体验。

---

## 📁 修改文件清单

### 1. `src/lib/decompositionAI.ts` ⭐ 新文件
**功能**：AI动态拆解问题生成服务

**核心函数**：
- `generateDynamicDecompositionQuestions(task)` - AI生成3个拆解引导问题
- `buildTaskInfoDescription(task)` - 构建任务信息描述
- `parseQuestionsFromResponse(content)` - 解析AI返回的问题
- `formatDynamicDecompositionMessage(task, questions)` - 格式化问题消息
- `generateDecompositionQuestionsWithFallback(task)` - 带降级方案的生成函数

**AI Prompt特点**：
- 聚焦任务拆解的核心维度：步骤、资源、依赖、时间
- 引导用户思考"如何分解"而不是"任务是什么"
- 根据任务复杂度调整问题深度
- 简洁友好（15-30字）
- 一次性输出全部3个问题

**降级机制**：
```typescript
try {
  // 尝试AI生成
  return { questions: aiQuestions, isAIGenerated: true }
} catch (error) {
  // 降级到规则模板（generateContextQuestions）
  return { questions: ruleBasedQuestions, isAIGenerated: false }
}
```

---

### 2. `src/hooks/useWorkflowAssistant.ts`
**修改内容**：
1. 导入新的AI服务
2. 任务拆解路径改为调用AI动态生成

**关键代码**：
```typescript
// 拆解路径：使用AI动态生成拆解问题
setSelectedTaskForDecompose(task)

// 显示加载动画
setIsSending(true)
streamAIMessage('正在分析任务，生成拆解引导问题...')

// 调用AI生成问题（带降级方案）
const result = await generateDecompositionQuestionsWithFallback(task)

// 清空加载消息，显示问题
setStreamingMessage('')
setIsSending(false)

// 保存问题到状态
setContextQuestions(result.questions)

// 进入上下文输入模式
setWorkflowMode('task-context-input')

// 显示问题消息
streamAIMessage(result.message)
```

---

### 3. `src/lib/contextQuestions.ts`
**状态**：保留原有代码，作为降级方案
- `generateContextQuestions(task)` - 规则模板生成问题
- `formatQuestionsMessage(task, questions)` - 格式化消息

---

## 🎨 AI Prompt设计

### 核心原则
1. 分析任务信息，识别拆解的关键维度
2. 生成3个苏格拉底式问题，引导用户思考如何拆解
3. 必须一次性输出全部3个问题

### 问题聚焦点
- 任务的核心步骤/阶段是什么？
- 需要哪些前置条件或资源？
- 哪些部分可以并行？哪些必须串行？
- 每个步骤大概需要多久？
- 可能的困难点或风险在哪里？

### DO（应该）
✅ 开放式提问，引导思考执行步骤和顺序
✅ 根据任务复杂度调整问题深度
✅ 简洁友好，每个问题15-30字
✅ 让用户自然地思考任务的分解方式

### DON'T（避免）
❌ 封闭式问题（能用"是/否"回答）
❌ 过于抽象或哲学化的问题
❌ 直接给出拆解方案
❌ 使用专业术语或复杂表达

### 示例
任务：准备年度总结报告
- 这份报告需要包含哪几个核心部分？每部分的重点是什么？
- 哪些数据或资料需要提前收集？需要找谁协助？
- 你打算如何安排时间？哪部分最耗时？

---

## 🆚 任务澄清 vs 任务拆解

| 维度 | 任务澄清 | 任务拆解 |
|------|----------|----------|
| **目标** | 补充任务信息 | 指导如何分解任务 |
| **问题聚焦** | 缺失信息、背景上下文 | 执行步骤、资源需求、时间规划 |
| **AI输入** | 任务的属性信息 | 任务的内容和复杂度 |
| **AI输出** | 澄清问题（填补信息） | 拆解引导问题（思考分解） |
| **用户回答** | 提供缺失的信息 | 思考并描述拆解思路 |

---

## 🧪 测试流程

### 测试场景1：复杂任务拆解
**任务信息**：
- 标题：准备项目汇报PPT
- 描述：需要展示项目进展、数据分析、未来规划
- 标签：difficult
- 预估时长：3小时

**预期结果**：
- ✅ 显示"正在分析任务，生成拆解引导问题..."
- ✅ AI生成3个针对性问题，例如：
  1. 这份PPT需要分几个部分来展示？每部分要突出什么核心内容？
  2. 你需要收集哪些数据和资料？有没有需要其他同事协助的地方？
  3. 哪个环节最耗时？你打算如何分配时间？

---

### 测试场景2：简单任务拆解
**任务信息**：
- 标题：买菜
- 描述：（空）
- 标签：easy

**预期结果**：
- ✅ AI生成适合简单任务的引导问题
- ✅ 问题更轻量，例如：
  1. 你打算买哪些菜？有购物清单吗？
  2. 需要去几个地方？顺序如何安排？
  3. 大概需要多长时间？

---

### 测试场景3：AI失败降级
**模拟方式**：
1. 临时修改API Key为无效值
2. 或断开网络连接

**预期结果**：
- ✅ 显示"正在分析任务，生成拆解引导问题..."
- ✅ AI调用失败后，自动降级到规则模板
- ✅ 用户看到规则生成的3个问题
- ✅ 控制台显示降级警告

---

### 测试场景4：加载动画
**测试步骤**：
1. 点击"任务拆解"
2. 选择一个任务
3. 观察AI生成过程

**预期结果**：
- ✅ 显示"正在分析任务，生成拆解引导问题..."
- ✅ 加载指示器显示（isSending = true）
- ✅ 1-2秒后显示3个问题
- ✅ 加载指示器消失

---

## 📊 改造效果评估

### 用户体验提升
| 维度 | 改造前 | 改造后 | 提升 |
|------|--------|--------|------|
| 问题针对性 | 规则模板 | AI动态生成 | ⭐⭐⭐ |
| 问题质量 | 通用问题 | 任务特定问题 | ⭐⭐⭐ |
| 加载反馈 | 无 | 有动画 | ⭐⭐ |
| 系统稳定性 | 一般 | 高（降级方案）| ⭐⭐⭐ |

### AI Prompt对比

**规则模板示例**：
1. 这个任务的最终目标是什么？你希望达到什么样的结果？
2. 你在完成这个任务时需要哪些资源或支持？
3. 有什么特殊的要求或时间限制吗？

**AI动态生成示例**（针对"准备项目汇报PPT"）：
1. 这份PPT需要分几个部分来展示？每部分要突出什么核心内容？
2. 你需要收集哪些数据和资料？有没有需要其他同事协助的地方？
3. 哪个环节最耗时？你打算如何分配时间？

**差异**：
- ✅ 更具体：从"资源或支持"到"数据、资料、同事协助"
- ✅ 更有针对性：根据"PPT"和"项目汇报"调整问题
- ✅ 更实用：直接问"如何分配时间"而不是"有时间限制吗"

---

## 🚀 后续优化方向

1. **考虑用户历史**：分析用户以往的拆解习惯，生成更个性化的问题
2. **任务模板识别**：识别常见任务类型（如"写报告"、"准备会议"），提供更精准的问题
3. **问题缓存**：相同类型的任务可复用问题，减少AI调用
4. **问题评分**：让用户对问题质量打分，用于优化prompt
5. **多轮引导**：如果用户回答不够详细，可以追问

---

## 📝 注意事项

1. **环境变量**：确保 `NEXT_PUBLIC_DOUBAO_API_KEY` 正确配置
2. **Token限制**：单次生成约消耗200 tokens（比澄清稍多，因为问题可能更长）
3. **响应时间**：AI生成约1-2秒，已关闭深度思考模式
4. **降级机制**：保留规则模板，确保AI失败时系统可用
5. **用户提示**：明确告诉用户"也可以提供其他任何你知道的信息"

---

## ✅ 验收标准

- [x] AI能根据任务内容生成3个拆解引导问题
- [x] 问题聚焦于"如何分解"而不是"任务是什么"
- [x] 显示"正在分析任务，生成拆解引导问题..."加载动画
- [x] AI失败时自动降级到规则模板
- [x] 无linter错误
- [x] 保持向后兼容，不影响其他功能
- [x] 用户提示包含"也可以提供其他任何你知道的信息"

---

## 🔗 相关文档

- [任务澄清AI升级文档](./CLARIFICATION_AI_UPGRADE.md)
- [时间估计改进文档](./TIME_ESTIMATION_IMPROVEMENTS.md)

---

**改造完成日期**：2025-10-17
**改造负责人**：AI Assistant
**审核状态**：待用户测试验证









